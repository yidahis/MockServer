# Mock Server

一个用于模拟API响应和记录真实请求日志的服务器，包含日志查看器前端应用。

## 项目结构

```
mockServer/
├── app.py                 # 主服务程序
├── mocked/                # 模拟响应数据文件夹
├── logs/                  # 记录的真实请求日志文件夹
├── apis/                  # API配置文件夹
├── log-viewer/           # 日志查看器前端应用
│   ├── public/           # 静态资源文件夹
│   │   └── logs/         # 日志文件的符号链接
│   ├── src/              # 前端源代码
│   │   ├── App.js        # 主应用组件
│   │   └── App.css       # 应用样式
│   ├── package.json      # 前端依赖配置
│   └── .env              # 环境变量配置
└── README.md             # 项目说明文档
```

## 功能特性

### 主服务 (app.py)
1. **API模拟响应**：
   - 根据请求URL和body内容匹配本地JSON文件，返回预定义的响应
   - 支持复杂的匹配规则，可根据请求内容返回不同的响应

2. **请求转发**：
   - 当请求未匹配到本地配置时，根据`origin-host`头部转发请求到真实服务器
   - 完整记录请求和响应信息到日志文件

3. **日志记录**：
   - 自动记录所有请求的详细信息，包括时间戳、HTTP方法、URL、请求头、请求体、响应头、响应体等
   - 日志文件以时间戳和请求内容的哈希值命名，确保唯一性

4. **日志查看API**：
   - 提供`/api/logs/files`端点获取所有日志文件列表
   - 提供`/logs/{filename}`端点获取单个日志文件内容
   - 支持通过`latest`参数获取新增日志文件列表

### 日志查看器 (log-viewer)
1. **实时日志查看**：
   - 左侧显示请求URL列表，右侧显示详细信息
   - 支持无限滚动加载历史日志
   - 自动轮询获取最新日志

2. **智能数据加载**：
   - 初始加载时获取所有日志文件
   - 后续轮询只获取新增日志文件
   - 按时间顺序排列日志（最新的在底部）

3. **用户体验优化**：
   - 滚动到底部时自动加载最新数据
   - 离开底部时暂停轮询，避免干扰历史数据浏览
   - 刷新页面后保持选中的日志项

4. **状态保持**：
   - 使用localStorage保存选中的日志项
   - 页面刷新后自动恢复选中状态

## 安装和运行

### 主服务

1. 安装依赖：
```bash
pip install flask flask-cors requests
```

2. 运行服务：
```bash
python app.py
```

服务将在 `http://localhost:3000` 启动。

### 日志查看器

1. 进入log-viewer目录：
```bash
cd log-viewer
```

2. 安装依赖：
```bash
npm install
```

3. 启动应用：
```bash
npm start
```

应用将在 `http://localhost:3666` 启动。

## 使用方法

### 配置模拟响应

1. 在`mocked`文件夹中创建以API路径命名的子文件夹
2. 在子文件夹中添加以请求内容特征命名的JSON文件
3. JSON文件内容即为预期的响应内容

### 发起请求

1. 向主服务发起请求时，添加`origin-host`头部指定真实服务器地址
2. 如果请求匹配到本地配置，则返回模拟响应
3. 如果未匹配到，则转发到`origin-host`指定的地址

### 查看日志

1. 访问日志查看器 `http://localhost:3666`
2. 浏览请求日志列表和详细信息
3. 系统会自动获取最新的日志数据

## API端点

### 主服务端点

- `GET/POST /{path}` - 通用请求处理端点
- `GET /api/logs/files` - 获取日志文件列表
- `GET /api/logs/files?latest={filename}` - 获取比指定文件更新的日志文件列表
- `GET /logs/{filename}` - 获取单个日志文件内容

### 日志查看器功能

- 实时轮询更新日志数据
- 无限滚动加载历史数据
- 保持选中状态
- 智能滚动控制

## 配置说明

### 环境变量

在`log-viewer/.env`文件中配置：
- `PORT=3666` - 前端应用端口

### 日志文件格式

日志文件以JSON格式存储，包含以下字段：
- `timestamp` - 请求时间戳
- `method` - HTTP方法
- `full-url` - 完整请求URL
- `headers` - 请求头
- `body` - 请求体
- `response` - 响应信息
- `cost` - 请求耗时

## 开发指南

### 添加新的模拟响应

1. 在`mocked`目录下创建新的API路径文件夹
2. 添加匹配请求特征的JSON文件
3. 文件名应能体现请求的关键特征
4. JSON内容为预期的响应数据

### 自定义日志查看器

1. 修改`log-viewer/src/App.js`调整UI逻辑
2. 修改`log-viewer/src/App.css`调整样式
3. 通过环境变量配置应用行为

## 注意事项

1. 确保主服务和日志查看器都正常运行
2. 主服务需要能够访问`origin-host`指定的真实服务器
3. 日志文件会持续增长，注意磁盘空间管理
4. 在生产环境中应适当调整轮询间隔以减少资源消耗